title: weigou前后端分离的实践
date: 2014-07-03
tags: 
 - frontend
 - web
 - node
comments: true
categories:
 - frontend
 - thinking
---

前后端分离这个事情，最近被提到的非常多，今天我也来聊聊

## 为什么要前后端分离

为什么要做这个事情呢？先和大家说一下我自己碰到的场景

    老大新开一个项目，我去找RD（Java）聊文件和代码组织结构，RD说，我们以前的公司都是FE先把HTML代码写好，RD加工成模板（velocity），稍微想了下, it drives me crazy...
        1. 我们自己mock数据，自己写HTML
        2. 搭建RD的一整套环境，用‘真实’测试数据开发
    这样带来的问题是
        1. 我们改了什么地方，还得周知RD知道，RD要将我们的HTML拆分成一些pagelets，就怕一些RD没这种思维，总之就是FE和RD耦合的过于紧密，大大降低工作效率
        2. RD的环境往往很复杂，搭建起来费力费时，而且新项目，还是得mock数据，降低效率
        
    这种开发方式完全不能接受
    
因此我们走上了前后端分离的不归路（我们自己不想回）

也许我们需要聊一下，什么是前后端分离了

## 什么是前后端分离

其实从当前很多项目上看的话，一个非常直观的前后端分离就是SPA（Single Page Application），SPA的确做到了前后端分离，前端和后端只是通过一些JSON的数据来进行交互，但是也带来了一些问题

1. 渲染都是通过JS在浏览器端完成，在文件加载进来之前会有一段时间的空白页
2. 不利于SEO

由于这些原因，SPA的开发方式往往只用在APP或者一些管理系统（SEO不重要），非常具有局限性

需要解决这两个问题，只能通过server，所以今天我们聊的前后端分离是`FE承担了一定量的后端开发工作，包括View和Controller，RD专注于做Model`，这就是我们今天聊的前后端分离

## 怎么做

如前面所说：

1. FE做View和Controller
2. RD专注于Model，做一些service

这是这么做的，很多人都会想知道怎么做

### 基于Node.js的前后端分离

早在一年半以前，我们产品线（百度微购）就已经做了前后端分离，只不过那时候是基于PHP+Yii框架来做的，也面临了一些问题：

* Yii框架太重，JS等CSS文件打散到各个action目录中，不利于FE维护前端代码
* 框架的init比较耗时，最少也要70ms
* 我们不擅长PHP
* ...

基于这些原因，我们小组调研开发了`node-framework`的框架，后续的新项目都会通过这种开发方式进行

**为什么选择node呢？**

* node对于IO密集型的web应用比较擅长，经测，`node-framework`在一台均衡型的机器QPS能达7000+
* 前后端都是JS，利于前后端模板公用
* 我们擅长node


### 我们怎么做

我们就以一个项目的声明周期来说

1. FE和RD根据需求订接口，产出接口文档
2. FE编写mock的数据，开发模板
3. 编写controllder和一些业务逻辑，acquire data from backend via dataloader.
4. 关闭mock的开关，连接RD的数据进行联调
5. 到发布的时候，编译生成一个pure的包
6. 上线打包好的文件

整个项目的lifecycle就是如此，过程中除非是接口变动，一般不会有其他的过多的沟通和interrupt

程序员在不被人打断的情况下，效率比较高

## 问题

### 增加了人力成本

从表面上看，的确增加了FE的开发量，Controller和View都由FE来写了

根据我们一年多的实践，这些增加的开发量对于前后端分离带来的收益来说可以忽略了，减少了很多多余的沟通，简化了很多流程

### 对FE的要求

FE既然介入了后端的工作，那就需要有后端的意识，怎样让后端返回更快，在这一点上，FE同学需要向RD同学学习一下

就目前我自己的经验来说主要是如下几点：

1. 是否需要缓存
2. 是否需要并行请求
3. 不必要的sync works是否能用MQ (message queue)
4. 一些具体的代码上的优化
5. ...

### 技术不成熟

很多FE都没有后端的经验，前后端分离之后，FE需要考虑很多之前RD来考虑的事情，比如说

* 日志怎么打，能帮助日后排查问题
* 系统稳定性
* 包括高并发的系统设计问题
* ...

### ...

## Promote

微购开发的node的前后端分离的解决方案名叫`node-framework`，是一整套的解决方案，用到的一些东西如下：

1. express
2. edp (百度ECOM前端体系开发的一套前端开发工具，amazing)
3. edp-webserver (用于开发时自动编译less文件)
4. etpl (模板，前端和后端都使用)
3. logger (基于winston封装的日志框架)
4. dataloader (自己写的)
5. ...

能帮助开发者完成的事情

1. js和less的自动编译打包
2. 静态文件版本管理
3. 编译完成自动上传静态文件至CDN
4. 用less写样式，自动编译成css放在线上
5. 有一套mock的机制，配置URL到data.json文件的对应关系即可
6. 基于node的MVC机制
7. ...

鉴于代码在公司内部的git上，也就不公开了

## 总结

这篇博文其实讲的就是一种RD和FE的分工协作的重新定义，整体来说，FE多做了一些事情，但大部分FE多乐意做这些多出来的事情，多多向一些走在前面的公司和团队学习。


Thanks.

